"use strict";
//AStar algorithm
/// <reference path="./priority-queue.d.ts" />
function ArraySwapIndex(arr, indexA, indexB) {
    [arr[indexA], arr[indexB]] = [arr[indexB], arr[indexA]];
}
//Represent each node in the search graph, has reference to its parent
// and children node.
class node {
    constructor(state, currentBlank, parent) {
        this.parent = parent;
        this.state = state.slice();
        this.blankIndex = currentBlank;
        this.children = [];
        this.value = 0;
    }
    get identifier() {
        return this.state.toString();
    }
    get path() {
        let result = [];
        let curr = this;
        while (curr !== null) {
            result.unshift(curr);
            curr = curr.parent;
        }
        return result;
    }
    getChildren() {
        if (this.children.length !== 0) {
            return this.children;
        }
        if (this.blankIndex % 3 !== 2) {
            //Blank move right
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex + 1);
            this.children.push(new node(newState, this.blankIndex + 1, this));
        }
        if (this.blankIndex % 3 !== 0) {
            //Blank move left
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex - 1);
            this.children.push(new node(newState, this.blankIndex - 1, this));
        }
        if (Math.floor(this.blankIndex / 3) !== 0) {
            //Blank move up
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex - 3);
            this.children.push(new node(newState, this.blankIndex - 3, this));
        }
        if (Math.floor(this.blankIndex / 3) !== 2) {
            //Blank move down
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex + 3);
            this.children.push(new node(newState, this.blankIndex + 3, this));
        }
        return this.children;
    }
}
class searchMethod {
    constructor(initState, currentBlank) {
        this.openTable = new PriorityQueue({
            comparator: function (a, b) {
                return a.value - b.value;
            },
        });
        this.closedTable = {};
        this.currentNode = new node(initState, currentBlank, null);
        this.openTable.queue(this.currentNode);
        this.next();
        this.totalStep = 0;
    }
    next() {
        if (this.checkResult(this.currentNode.state)) {
            return [this.currentNode.state, this.currentNode.blankIndex];
        }
        this.totalStep++;
        if (this.openTable.length === 0) {
            alert("搜索失败");
            throw "Empty open table";
        }
        let newNode = this.openTable.peek();
        while ((newNode).identifier in this.closedTable) {
            this.openTable.dequeue();
            if (this.openTable.length === 0) {
                alert("搜索失败");
                throw "Empty open table";
            }
            newNode = this.openTable.peek();
        }
        this.openTable.dequeue();
        this.closedTable[newNode.identifier] = newNode;
        this.currentNode = newNode;
        let children = this.currentNode.getChildren();
        for (let child of children) {
            this.addNewOpenNodeWithVal(child);
        }
        return [newNode.state, newNode.blankIndex];
    }
    getLowestNode() {
        return this.openTable.peek();
    }
    runAll() {
        while (true) {
            let [state, blank] = this.next();
            if (this.checkResult(state)) {
                break;
            }
        }
    }
    checkResult(state) {
        for (let i = 0; i < 9; i++) {
            if (state[i] !== i) {
                return false;
            }
        }
        return true;
    }
    get pathToCurrent() {
        return this.currentNode.path;
    }
    get steps() { return this.totalStep; }
}
class aStarH1 extends searchMethod {
    addNewOpenNodeWithVal(newNode) {
        if (!(newNode.identifier in this.closedTable)) {
            //The cost from root to the current node, i.e g*(n)
            let currentCost = newNode.path.length;
            //The cost from current node to destination(h1*(n)) is estimated
            //by the distance of each misplaced number to its actual position.
            let estimatedMinCost = 0;
            for (let i = 0; i < newNode.state.length; i++) {
                if (newNode.state[i] !== i) {
                    estimatedMinCost++;
                }
            }
            newNode.value = currentCost + estimatedMinCost;
            this.openTable.queue(newNode);
        }
    }
}
class aStarH2 extends searchMethod {
    addNewOpenNodeWithVal(newNode) {
        if (!(newNode.identifier in this.closedTable)) {
            //The cost from root to the current node, i.e g*(n)
            let currentCost = newNode.path.length;
            //The cost from current node to destination(h1*(n)) is estimated
            //by the sum of the column and row differences in each misplaced position.
            let estimatedMinCost = 0;
            for (let i = 0; i < newNode.state.length; i++) {
                //Row differences
                estimatedMinCost += Math.abs(i / 3 - newNode.state[i] / 3);
                //Column differences
                estimatedMinCost += Math.abs(i % 3 - newNode.state[i] % 3);
            }
            newNode.value = currentCost + estimatedMinCost;
            this.openTable.queue(newNode);
        }
    }
}
class bfs extends searchMethod {
    addNewOpenNodeWithVal(newNode) {
        if (!(newNode.identifier in this.closedTable)) {
            newNode.value = newNode.parent.value + 1;
            this.openTable.queue(newNode);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYVN0YXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYVN0YXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLGlCQUFpQjtBQUNqQiw4Q0FBOEM7QUFFOUMsU0FBUyxjQUFjLENBQUksR0FBYSxFQUFFLE1BQWMsRUFBRSxNQUFjO0lBQ3BFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQzVELENBQUM7QUFFRCxzRUFBc0U7QUFDdEUscUJBQXFCO0FBQ3JCLE1BQU0sSUFBSTtJQU9OLFlBQVksS0FBZSxFQUFFLFlBQW9CLEVBQUUsTUFBaUI7UUFDaEUsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELElBQVcsVUFBVTtRQUNqQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNYLElBQUksTUFBTSxHQUFXLEVBQUUsQ0FBQztRQUN4QixJQUFJLElBQUksR0FBYyxJQUFJLENBQUM7UUFDM0IsT0FBTyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2xCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7U0FDdEI7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRU0sV0FBVztR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QUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQzthQUMxRDtZQUNELE9BQU8sQ0FBQyxLQUFLLEdBQUcsV0FBVyxHQUFHLGdCQUFnQixDQUFDO1lBRS9DLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2pDO0lBQ0wsQ0FBQztDQUNKO0FBRUQsTUFBTSxHQUFJLFNBQVEsWUFBWTtJQUVuQixxQkFBcUIsQ0FBQyxPQUFhO1FBQ3RDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQzNDLE9BQU8sQ0FBQyxLQUFLLEdBQVUsT0FBTyxDQUFDLE1BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2pDO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiXG4vL0FTdGFyIGFsZ29yaXRobVxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vcHJpb3JpdHktcXVldWUuZC50c1wiIC8+XG5cbmZ1bmN0aW9uIEFycmF5U3dhcEluZGV4PFQ+KGFycjogQXJyYXk8VD4sIGluZGV4QTogbnVtYmVyLCBpbmRleEI6IG51bWJlcikge1xuICAgIFthcnJbaW5kZXhBXSwgYXJyW2luZGV4Ql1dID0gW2FycltpbmRleEJdLCBhcnJbaW5kZXhBXV07XG59XG5cbi8vUmVwcmVzZW50IGVhY2ggbm9kZSBpbiB0aGUgc2VhcmNoIGdyYXBoLCBoYXMgcmVmZXJlbmNlIHRvIGl0cyBwYXJlbnRcbi8vIGFuZCBjaGlsZHJlbiBub2RlLlxuY2xhc3Mgbm9kZSB7XG4gICAgcHVibGljIHBhcmVudDogbm9kZXxudWxsO1xuICAgIHB1YmxpYyBjaGlsZHJlbjogbm9kZVtdO1xuICAgIHB1YmxpYyBzdGF0ZTogbnVtYmVyW107XG4gICAgcHVibGljIGJsYW5rSW5kZXg6IG51bWJlcjtcbiAgICAvL3RoZSB2YWx1ZSBpcyB0aGUgZihuKSBvZiB0aGUgbm9kZS5cbiAgICBwdWJsaWMgdmFsdWU6IG51bWJlcjtcbiAgICBjb25zdHJ1Y3RvcihzdGF0ZTogbnVtYmVyW10sIGN1cnJlbnRCbGFuazogbnVtYmVyLCBwYXJlbnQ6IG5vZGV8bnVsbCkge1xuICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlLnNsaWNlKCk7XG4gICAgICAgIHRoaXMuYmxhbmtJbmRleCA9IGN1cnJlbnRCbGFuaztcbiAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdO1xuICAgICAgICB0aGlzLnZhbHVlID0gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlkZW50aWZpZXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLnRvU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBwYXRoKCk6IG5vZGVbXSB7XG4gICAgICAgIGxldCByZXN1bHQ6IG5vZGVbXSA9IFtdO1xuICAgICAgICBsZXQgY3Vycjogbm9kZXxudWxsID0gdGhpcztcbiAgICAgICAgd2hpbGUgKGN1cnIgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdC51bnNoaWZ0KGN1cnIpO1xuICAgICAgICAgICAgY3VyciA9IGN1cnIucGFyZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENoaWxkcmVuKCk6IG5vZGVbXSB7XG4gICAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW5cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5ibGFua0luZGV4ICUgMyAhPT0gMikge1xuICAgICAgICAgICAgLy9CbGFuayBtb3ZlIHJpZ2h0XG4gICAgICAgICAgICBsZXQgbmV3U3RhdGUgPSB0aGlzLnN0YXRlLnNsaWNlKCk7XG4gICAgICAgICAgICBBcnJheVN3YXBJbmRleChuZXdTdGF0ZSwgdGhpcy5ibGFua0luZGV4LCB0aGlzLmJsYW5rSW5kZXgrMSk7XG4gICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnB1c2gobmV3IG5vZGUobmV3U3RhdGUsIHRoaXMuYmxhbmtJbmRleCArIDEsIHRoaXMpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5ibGFua0luZGV4ICUgMyAhPT0gMCkge1xuICAgICAgICAgICAgLy9CbGFuayBtb3ZlIGxlZnRcbiAgICAgICAgICAgIGxldCBuZXdTdGF0ZSA9IHRoaXMuc3RhdGUuc2xpY2UoKTtcbiAgICAgICAgICAgIEFycmF5U3dhcEluZGV4KG5ld1N0YXRlLCB0aGlzLmJsYW5rSW5kZXgsIHRoaXMuYmxhbmtJbmRleC0xKTtcbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChuZXcgbm9kZShuZXdTdGF0ZSwgdGhpcy5ibGFua0luZGV4IC0gMSwgdGhpcykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChNYXRoLmZsb29yKHRoaXMuYmxhbmtJbmRleCAvIDMpICE9PSAwKSB7XG4gICAgICAgICAgICAvL0JsYW5rIG1vdmUgdXBcbiAgICAgICAgICAgIGxldCBuZXdTdGF0ZSA9IHRoaXMuc3RhdGUuc2xpY2UoKTtcbiAgICAgICAgICAgIEFycmF5U3dhcEluZGV4KG5ld1N0YXRlLCB0aGlzLmJsYW5rSW5kZXgsIHRoaXMuYmxhbmtJbmRleC0zKTtcbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChuZXcgbm9kZShuZXdTdGF0ZSwgdGhpcy5ibGFua0luZGV4IC0gMywgdGhpcykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChNYXRoLmZsb29yKHRoaXMuYmxhbmtJbmRleCAvIDMpICE9PSAyKSB7XG4gICAgICAgICAgICAvL0JsYW5rIG1vdmUgZG93blxuICAgICAgICAgICAgbGV0IG5ld1N0YXRlID0gdGhpcy5zdGF0ZS5zbGljZSgpO1xuICAgICAgICAgICAgQXJyYXlTd2FwSW5kZXgobmV3U3RhdGUsIHRoaXMuYmxhbmtJbmRleCwgdGhpcy5ibGFua0luZGV4KzMpO1xuICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKG5ldyBub2RlKG5ld1N0YXRlLCB0aGlzLmJsYW5rSW5kZXggKyAzLCB0aGlzKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW47XG4gICAgfVxufVxuXG5cbmFic3RyYWN0IGNsYXNzIHNlYXJjaE1ldGhvZCB7XG4gICAgcHVibGljIG9wZW5UYWJsZTogUHJpb3JpdHlRdWV1ZTxub2RlPjtcbiAgICBwdWJsaWMgY2xvc2VkVGFibGU6IHtbaWQ6c3RyaW5nXTogbm9kZX07XG5cbiAgICBwdWJsaWMgY3VycmVudE5vZGU6IG5vZGU7XG4gICAgLy9UaGUgcGF0aCBmcm9tIGluaXRpYWwgbm9kZSB0byB0aGUgY3VycmVudCBub2RlXG4gICAgcHJpdmF0ZSB0b3RhbFN0ZXA6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKGluaXRTdGF0ZTogbnVtYmVyW10sIGN1cnJlbnRCbGFuazogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMub3BlblRhYmxlID0gbmV3IFByaW9yaXR5UXVldWU8bm9kZT4oe1xuICAgICAgICAgICAgY29tcGFyYXRvcjogZnVuY3Rpb24gKGE6bm9kZSwgYjpub2RlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGEudmFsdWUgLSBiLnZhbHVlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2xvc2VkVGFibGUgPSB7fTtcbiAgICAgICAgdGhpcy5jdXJyZW50Tm9kZSA9IG5ldyBub2RlKGluaXRTdGF0ZSwgY3VycmVudEJsYW5rLCBudWxsKTtcbiAgICAgICAgdGhpcy5vcGVuVGFibGUucXVldWUodGhpcy5jdXJyZW50Tm9kZSk7XG4gICAgICAgIHRoaXMubmV4dCgpO1xuICAgICAgICB0aGlzLnRvdGFsU3RlcCA9IDA7XG4gICAgfVxuXG4gICAgcHVibGljIG5leHQoKTogW251bWJlcltdLCBudW1iZXJdIHtcbiAgICAgICAgaWYgKHRoaXMuY2hlY2tSZXN1bHQodGhpcy5jdXJyZW50Tm9kZS5zdGF0ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBbdGhpcy5jdXJyZW50Tm9kZS5zdGF0ZSwgdGhpcy5jdXJyZW50Tm9kZS5ibGFua0luZGV4XTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRvdGFsU3RlcCsrO1xuICAgICAgICBpZiAodGhpcy5vcGVuVGFibGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBhbGVydChcIuaQnOe0ouWksei0pVwiKTtcbiAgICAgICAgICAgIHRocm93IFwiRW1wdHkgb3BlbiB0YWJsZVwiO1xuICAgICAgICB9XG4gICAgICAgIGxldCBuZXdOb2RlID0gdGhpcy5vcGVuVGFibGUucGVlaygpO1xuICAgICAgICB3aGlsZSAoKG5ld05vZGUpLmlkZW50aWZpZXIgaW4gdGhpcy5jbG9zZWRUYWJsZSkge1xuICAgICAgICAgICAgdGhpcy5vcGVuVGFibGUuZGVxdWV1ZSgpO1xuICAgICAgICAgICAgaWYgKHRoaXMub3BlblRhYmxlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGFsZXJ0KFwi5pCc57Si5aSx6LSlXCIpO1xuICAgICAgICAgICAgICAgIHRocm93IFwiRW1wdHkgb3BlbiB0YWJsZVwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3Tm9kZSA9IHRoaXMub3BlblRhYmxlLnBlZWsoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9wZW5UYWJsZS5kZXF1ZXVlKCk7XG4gICAgICAgIHRoaXMuY2xvc2VkVGFibGVbbmV3Tm9kZS5pZGVudGlmaWVyXSA9IG5ld05vZGU7XG4gICAgICAgIHRoaXMuY3VycmVudE5vZGUgPSBuZXdOb2RlO1xuICAgICAgICBsZXQgY2hpbGRyZW4gPSB0aGlzLmN1cnJlbnROb2RlLmdldENoaWxkcmVuKCk7XG4gICAgICAgIGZvciAobGV0IGNoaWxkIG9mIGNoaWxkcmVuKSB7XG4gICAgICAgICAgICB0aGlzLmFkZE5ld09wZW5Ob2RlV2l0aFZhbChjaGlsZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtuZXdOb2RlLnN0YXRlLCBuZXdOb2RlLmJsYW5rSW5kZXhdO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb3dlc3ROb2RlKCkgOiBub2RlfHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wZW5UYWJsZS5wZWVrKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJ1bkFsbCgpOiBhbnkge1xuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgbGV0IFtzdGF0ZSwgYmxhbmtdID0gdGhpcy5uZXh0KCk7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGVja1Jlc3VsdChzdGF0ZSkpIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjaGVja1Jlc3VsdChzdGF0ZTogbnVtYmVyW10pOiBib29sZWFuIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA5OyBpKyspIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZVtpXSAhPT0gaSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHBhdGhUb0N1cnJlbnQoKTogbm9kZVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudE5vZGUucGF0aDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHN0ZXBzKCkgeyByZXR1cm4gdGhpcy50b3RhbFN0ZXA7IH1cblxuICAgIHB1YmxpYyBhYnN0cmFjdCBhZGROZXdPcGVuTm9kZVdpdGhWYWwobmV3Tm9kZTogbm9kZSk6IHZvaWQ7XG5cbn1cblxuY2xhc3MgYVN0YXJIMSBleHRlbmRzIHNlYXJjaE1ldGhvZHtcblxuICAgIHB1YmxpYyBhZGROZXdPcGVuTm9kZVdpdGhWYWwobmV3Tm9kZTogbm9kZSk6IHZvaWQge1xuICAgICAgICBpZiAoIShuZXdOb2RlLmlkZW50aWZpZXIgaW4gdGhpcy5jbG9zZWRUYWJsZSkpIHtcbiAgICAgICAgICAgIC8vVGhlIGNvc3QgZnJvbSByb290IHRvIHRoZSBjdXJyZW50IG5vZGUsIGkuZSBnKihuKVxuICAgICAgICAgICAgbGV0IGN1cnJlbnRDb3N0ID0gbmV3Tm9kZS5wYXRoLmxlbmd0aDtcbiAgICAgICAgICAgIC8vVGhlIGNvc3QgZnJvbSBjdXJyZW50IG5vZGUgdG8gZGVzdGluYXRpb24oaDEqKG4pKSBpcyBlc3RpbWF0ZWRcbiAgICAgICAgICAgIC8vYnkgdGhlIGRpc3RhbmNlIG9mIGVhY2ggbWlzcGxhY2VkIG51bWJlciB0byBpdHMgYWN0dWFsIHBvc2l0aW9uLlxuICAgICAgICAgICAgbGV0IGVzdGltYXRlZE1pbkNvc3QgPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXdOb2RlLnN0YXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5ld05vZGUuc3RhdGVbaV0gIT09IGkpIHtcbiAgICAgICAgICAgICAgICAgICAgZXN0aW1hdGVkTWluQ29zdCsrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ld05vZGUudmFsdWUgPSBjdXJyZW50Q29zdCArIGVzdGltYXRlZE1pbkNvc3Q7XG5cbiAgICAgICAgICAgIHRoaXMub3BlblRhYmxlLnF1ZXVlKG5ld05vZGUpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5jbGFzcyBhU3RhckgyIGV4dGVuZHMgc2VhcmNoTWV0aG9ke1xuXG4gICAgcHVibGljIGFkZE5ld09wZW5Ob2RlV2l0aFZhbChuZXdOb2RlOiBub2RlKTogdm9pZCB7XG4gICAgICAgIGlmICghKG5ld05vZGUuaWRlbnRpZmllciBpbiB0aGlzLmNsb3NlZFRhYmxlKSkge1xuICAgICAgICAgICAgLy9UaGUgY29zdCBmcm9tIHJvb3QgdG8gdGhlIGN1cnJlbnQgbm9kZSwgaS5lIGcqKG4pXG4gICAgICAgICAgICBsZXQgY3VycmVudENvc3QgPSBuZXdOb2RlLnBhdGgubGVuZ3RoO1xuICAgICAgICAgICAgLy9UaGUgY29zdCBmcm9tIGN1cnJlbnQgbm9kZSB0byBkZXN0aW5hdGlvbihoMSoobikpIGlzIGVzdGltYXRlZFxuICAgICAgICAgICAgLy9ieSB0aGUgc3VtIG9mIHRoZSBjb2x1bW4gYW5kIHJvdyBkaWZmZXJlbmNlcyBpbiBlYWNoIG1pc3BsYWNlZCBwb3NpdGlvbi5cbiAgICAgICAgICAgIGxldCBlc3RpbWF0ZWRNaW5Db3N0ID0gMDtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmV3Tm9kZS5zdGF0ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIC8vUm93IGRpZmZlcmVuY2VzXG4gICAgICAgICAgICAgICAgZXN0aW1hdGVkTWluQ29zdCArPSBNYXRoLmFicyhpLzMgLSBuZXdOb2RlLnN0YXRlW2ldLzMpO1xuICAgICAgICAgICAgICAgIC8vQ29sdW1uIGRpZmZlcmVuY2VzXG4gICAgICAgICAgICAgICAgZXN0aW1hdGVkTWluQ29zdCArPSBNYXRoLmFicyhpJTMgLSBuZXdOb2RlLnN0YXRlW2ldJTMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3Tm9kZS52YWx1ZSA9IGN1cnJlbnRDb3N0ICsgZXN0aW1hdGVkTWluQ29zdDtcblxuICAgICAgICAgICAgdGhpcy5vcGVuVGFibGUucXVldWUobmV3Tm9kZSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmNsYXNzIGJmcyBleHRlbmRzIHNlYXJjaE1ldGhvZCB7XG5cbiAgICBwdWJsaWMgYWRkTmV3T3Blbk5vZGVXaXRoVmFsKG5ld05vZGU6IG5vZGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKCEobmV3Tm9kZS5pZGVudGlmaWVyIGluIHRoaXMuY2xvc2VkVGFibGUpKSB7XG4gICAgICAgICAgICBuZXdOb2RlLnZhbHVlID0gKDxub2RlPm5ld05vZGUucGFyZW50KS52YWx1ZSArIDE7XG4gICAgICAgICAgICB0aGlzLm9wZW5UYWJsZS5xdWV1ZShuZXdOb2RlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5cbiJdfQ==