"use strict";
//AStar algorithm
/// <reference path="./priority-queue.d.ts" />
function ArraySwapIndex(arr, indexA, indexB) {
    [arr[indexA], arr[indexB]] = [arr[indexB], arr[indexA]];
}
//Represent each node in the search graph, has reference to its parent
// and children node.
class node {
    constructor(state, currentBlank, parent) {
        this.parent = parent;
        this.state = state.slice();
        this.blankIndex = currentBlank;
        this.children = [];
        this.value = 0;
    }
    get identifier() {
        return this.state.toString();
    }
    get path() {
        let result = [];
        let curr = this;
        while (curr !== null) {
            result.unshift(curr);
            curr = curr.parent;
        }
        return result;
    }
    getChildren() {
        if (this.children.length !== 0) {
            return this.children;
        }
        if (this.blankIndex % 3 !== 2) {
            //Blank move right
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex + 1);
            this.children.push(new node(newState, this.blankIndex + 1, this));
        }
        if (this.blankIndex % 3 !== 0) {
            //Blank move left
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex - 1);
            this.children.push(new node(newState, this.blankIndex - 1, this));
        }
        if (Math.floor(this.blankIndex / 3) !== 0) {
            //Blank move up
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex - 3);
            this.children.push(new node(newState, this.blankIndex - 3, this));
        }
        if (Math.floor(this.blankIndex / 3) !== 2) {
            //Blank move down
            let newState = this.state.slice();
            ArraySwapIndex(newState, this.blankIndex, this.blankIndex + 3);
            this.children.push(new node(newState, this.blankIndex + 3, this));
        }
        return this.children;
    }
}
class searchMethod {
    constructor(initState, currentBlank) {
        this.openTable = new PriorityQueue({
            comparator: function (a, b) {
                return a.value - b.value;
            },
        });
        this.closedTable = {};
        this.currentNode = new node(initState, currentBlank, null);
        this.openTable.queue(this.currentNode);
        this.next();
        this.totalStep = 0;
    }
    next() {
        if (this.checkResult(this.currentNode.state)) {
            return [this.currentNode.state, this.currentNode.blankIndex];
        }
        this.totalStep++;
        if (this.openTable.length === 0) {
            alert("搜索失败");
            throw "Empty open table";
        }
        let newNode = this.openTable.peek();
        while ((newNode).identifier in this.closedTable) {
            this.openTable.dequeue();
            if (this.openTable.length === 0) {
                alert("搜索失败");
                throw "Empty open table";
            }
            newNode = this.openTable.peek();
        }
        this.openTable.dequeue();
        this.closedTable[newNode.identifier] = newNode;
        this.currentNode = newNode;
        let children = this.currentNode.getChildren();
        for (let child of children) {
            this.addNewOpenNodeWithVal(child);
        }
        return [newNode.state, newNode.blankIndex];
    }
    getLowestNode() {
        return this.openTable.peek();
    }
    runAll() {
        while (true) {
            let [state, blank] = this.next();
            if (this.checkResult(state)) {
                break;
            }
        }
    }
    checkResult(state) {
        for (let i = 0; i < 9; i++) {
            if (state[i] !== i) {
                return false;
            }
        }
        return true;
    }
    get pathToCurrent() {
        return this.currentNode.path;
    }
    get steps() { return this.totalStep; }
}
class aStarH1 extends searchMethod {
    addNewOpenNodeWithVal(newNode) {
        if (!(newNode.identifier in this.closedTable)) {
            //The cost from root to the current node, i.e g*(n)
            let currentCost = newNode.path.length;
            //The cost from current node to destination(h1*(n)) is estimated
            //by the number of misplaced numbers.
            let estimatedMinCost = 0;
            for (let i = 0; i < newNode.state.length; i++) {
                if (newNode.state[i] !== i) {
                    estimatedMinCost += 1;
                }
            }
            newNode.value = currentCost + estimatedMinCost;
            this.openTable.queue(newNode);
        }
    }
}
class aStarH2 extends searchMethod {
    addNewOpenNodeWithVal(newNode) {
        if (!(newNode.identifier in this.closedTable)) {
            //The cost from root to the current node, i.e g*(n)
            let currentCost = newNode.path.length;
            //The cost from current node to destination(h1*(n)) is estimated
            //by the sum of the column and row differences in each position.
            let estimatedMinCost = 0;
            for (let i = 0; i < newNode.state.length; i++) {
                //Row differences
                estimatedMinCost += Math.abs(i / 3 - newNode.state[i] / 3);
                //Column differences
                estimatedMinCost += Math.abs(i % 3 - newNode.state[i] % 3);
            }
            newNode.value = currentCost + estimatedMinCost;
            this.openTable.queue(newNode);
        }
    }
}
class bfs extends searchMethod {
    addNewOpenNodeWithVal(newNode) {
        if (!(newNode.identifier in this.closedTable)) {
            newNode.value = newNode.parent.value + 1;
            this.openTable.queue(newNode);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYVN0YXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYVN0YXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLGlCQUFpQjtBQUNqQiw4Q0FBOEM7QUFFOUMsU0FBUyxjQUFjLENBQUksR0FBYSxFQUFFLE1BQWMsRUFBRSxNQUFjO0lBQ3BFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQzVELENBQUM7QUFFRCxzRUFBc0U7QUFDdEUscUJBQXFCO0FBQ3JCLE1BQU0sSUFBSTtJQU9OLFlBQVksS0FBZSxFQUFFLFlBQW9CLEVBQUUsTUFBaUI7UUFDaEUsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELElBQVcsVUFBVTtRQUNqQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNYLElBQUksTUFBTSxHQUFXLEVBQUUsQ0FBQztRQUN4QixJQUFJLElBQUksR0FBYyxJQUFJLENBQUM7UUFDM0IsT0FBTyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2xCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7U0FDdEI7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRU0sV0FBVztR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QUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzFEO1lBQ0QsT0FBTyxDQUFDLEtBQUssR0FBRyxXQUFXLEdBQUcsZ0JBQWdCLENBQUM7WUFFL0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDakM7SUFDTCxDQUFDO0NBQ0o7QUFFRCxNQUFNLEdBQUksU0FBUSxZQUFZO0lBRW5CLHFCQUFxQixDQUFDLE9BQWE7UUFDdEMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDM0MsT0FBTyxDQUFDLEtBQUssR0FBVSxPQUFPLENBQUMsTUFBTyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDakM7SUFDTCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vQVN0YXIgYWxnb3JpdGhtXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi9wcmlvcml0eS1xdWV1ZS5kLnRzXCIgLz5cblxuZnVuY3Rpb24gQXJyYXlTd2FwSW5kZXg8VD4oYXJyOiBBcnJheTxUPiwgaW5kZXhBOiBudW1iZXIsIGluZGV4QjogbnVtYmVyKSB7XG4gICAgW2FycltpbmRleEFdLCBhcnJbaW5kZXhCXV0gPSBbYXJyW2luZGV4Ql0sIGFycltpbmRleEFdXTtcbn1cblxuLy9SZXByZXNlbnQgZWFjaCBub2RlIGluIHRoZSBzZWFyY2ggZ3JhcGgsIGhhcyByZWZlcmVuY2UgdG8gaXRzIHBhcmVudFxuLy8gYW5kIGNoaWxkcmVuIG5vZGUuXG5jbGFzcyBub2RlIHtcbiAgICBwdWJsaWMgcGFyZW50OiBub2RlfG51bGw7XG4gICAgcHVibGljIGNoaWxkcmVuOiBub2RlW107XG4gICAgcHVibGljIHN0YXRlOiBudW1iZXJbXTtcbiAgICBwdWJsaWMgYmxhbmtJbmRleDogbnVtYmVyO1xuICAgIC8vdGhlIHZhbHVlIGlzIHRoZSBmKG4pIG9mIHRoZSBub2RlLlxuICAgIHB1YmxpYyB2YWx1ZTogbnVtYmVyO1xuICAgIGNvbnN0cnVjdG9yKHN0YXRlOiBudW1iZXJbXSwgY3VycmVudEJsYW5rOiBudW1iZXIsIHBhcmVudDogbm9kZXxudWxsKSB7XG4gICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xuICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGUuc2xpY2UoKTtcbiAgICAgICAgdGhpcy5ibGFua0luZGV4ID0gY3VycmVudEJsYW5rO1xuICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107XG4gICAgICAgIHRoaXMudmFsdWUgPSAwO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaWRlbnRpZmllcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHBhdGgoKTogbm9kZVtdIHtcbiAgICAgICAgbGV0IHJlc3VsdDogbm9kZVtdID0gW107XG4gICAgICAgIGxldCBjdXJyOiBub2RlfG51bGwgPSB0aGlzO1xuICAgICAgICB3aGlsZSAoY3VyciAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0LnVuc2hpZnQoY3Vycik7XG4gICAgICAgICAgICBjdXJyID0gY3Vyci5wYXJlbnQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q2hpbGRyZW4oKTogbm9kZVtdIHtcbiAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlblxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmJsYW5rSW5kZXggJSAzICE9PSAyKSB7XG4gICAgICAgICAgICAvL0JsYW5rIG1vdmUgcmlnaHRcbiAgICAgICAgICAgIGxldCBuZXdTdGF0ZSA9IHRoaXMuc3RhdGUuc2xpY2UoKTtcbiAgICAgICAgICAgIEFycmF5U3dhcEluZGV4KG5ld1N0YXRlLCB0aGlzLmJsYW5rSW5kZXgsIHRoaXMuYmxhbmtJbmRleCsxKTtcbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChuZXcgbm9kZShuZXdTdGF0ZSwgdGhpcy5ibGFua0luZGV4ICsgMSwgdGhpcykpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmJsYW5rSW5kZXggJSAzICE9PSAwKSB7XG4gICAgICAgICAgICAvL0JsYW5rIG1vdmUgbGVmdFxuICAgICAgICAgICAgbGV0IG5ld1N0YXRlID0gdGhpcy5zdGF0ZS5zbGljZSgpO1xuICAgICAgICAgICAgQXJyYXlTd2FwSW5kZXgobmV3U3RhdGUsIHRoaXMuYmxhbmtJbmRleCwgdGhpcy5ibGFua0luZGV4LTEpO1xuICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKG5ldyBub2RlKG5ld1N0YXRlLCB0aGlzLmJsYW5rSW5kZXggLSAxLCB0aGlzKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKE1hdGguZmxvb3IodGhpcy5ibGFua0luZGV4IC8gMykgIT09IDApIHtcbiAgICAgICAgICAgIC8vQmxhbmsgbW92ZSB1cFxuICAgICAgICAgICAgbGV0IG5ld1N0YXRlID0gdGhpcy5zdGF0ZS5zbGljZSgpO1xuICAgICAgICAgICAgQXJyYXlTd2FwSW5kZXgobmV3U3RhdGUsIHRoaXMuYmxhbmtJbmRleCwgdGhpcy5ibGFua0luZGV4LTMpO1xuICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKG5ldyBub2RlKG5ld1N0YXRlLCB0aGlzLmJsYW5rSW5kZXggLSAzLCB0aGlzKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKE1hdGguZmxvb3IodGhpcy5ibGFua0luZGV4IC8gMykgIT09IDIpIHtcbiAgICAgICAgICAgIC8vQmxhbmsgbW92ZSBkb3duXG4gICAgICAgICAgICBsZXQgbmV3U3RhdGUgPSB0aGlzLnN0YXRlLnNsaWNlKCk7XG4gICAgICAgICAgICBBcnJheVN3YXBJbmRleChuZXdTdGF0ZSwgdGhpcy5ibGFua0luZGV4LCB0aGlzLmJsYW5rSW5kZXgrMyk7XG4gICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnB1c2gobmV3IG5vZGUobmV3U3RhdGUsIHRoaXMuYmxhbmtJbmRleCArIDMsIHRoaXMpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbjtcbiAgICB9XG59XG5cblxuYWJzdHJhY3QgY2xhc3Mgc2VhcmNoTWV0aG9kIHtcbiAgICBwdWJsaWMgb3BlblRhYmxlOiBQcmlvcml0eVF1ZXVlPG5vZGU+O1xuICAgIHB1YmxpYyBjbG9zZWRUYWJsZToge1tpZDpzdHJpbmddOiBub2RlfTtcblxuICAgIHB1YmxpYyBjdXJyZW50Tm9kZTogbm9kZTtcbiAgICAvL1RoZSBwYXRoIGZyb20gaW5pdGlhbCBub2RlIHRvIHRoZSBjdXJyZW50IG5vZGVcbiAgICBwcml2YXRlIHRvdGFsU3RlcDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoaW5pdFN0YXRlOiBudW1iZXJbXSwgY3VycmVudEJsYW5rOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5vcGVuVGFibGUgPSBuZXcgUHJpb3JpdHlRdWV1ZTxub2RlPih7XG4gICAgICAgICAgICBjb21wYXJhdG9yOiBmdW5jdGlvbiAoYTpub2RlLCBiOm5vZGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYS52YWx1ZSAtIGIudmFsdWU7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jbG9zZWRUYWJsZSA9IHt9O1xuICAgICAgICB0aGlzLmN1cnJlbnROb2RlID0gbmV3IG5vZGUoaW5pdFN0YXRlLCBjdXJyZW50QmxhbmssIG51bGwpO1xuICAgICAgICB0aGlzLm9wZW5UYWJsZS5xdWV1ZSh0aGlzLmN1cnJlbnROb2RlKTtcbiAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgIHRoaXMudG90YWxTdGVwID0gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgbmV4dCgpOiBbbnVtYmVyW10sIG51bWJlcl0ge1xuICAgICAgICBpZiAodGhpcy5jaGVja1Jlc3VsdCh0aGlzLmN1cnJlbnROb2RlLnN0YXRlKSkge1xuICAgICAgICAgICAgcmV0dXJuIFt0aGlzLmN1cnJlbnROb2RlLnN0YXRlLCB0aGlzLmN1cnJlbnROb2RlLmJsYW5rSW5kZXhdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG90YWxTdGVwKys7XG4gICAgICAgIGlmICh0aGlzLm9wZW5UYWJsZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGFsZXJ0KFwi5pCc57Si5aSx6LSlXCIpO1xuICAgICAgICAgICAgdGhyb3cgXCJFbXB0eSBvcGVuIHRhYmxlXCI7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5ld05vZGUgPSB0aGlzLm9wZW5UYWJsZS5wZWVrKCk7XG4gICAgICAgIHdoaWxlICgobmV3Tm9kZSkuaWRlbnRpZmllciBpbiB0aGlzLmNsb3NlZFRhYmxlKSB7XG4gICAgICAgICAgICB0aGlzLm9wZW5UYWJsZS5kZXF1ZXVlKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5vcGVuVGFibGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgYWxlcnQoXCLmkJzntKLlpLHotKVcIik7XG4gICAgICAgICAgICAgICAgdGhyb3cgXCJFbXB0eSBvcGVuIHRhYmxlXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXdOb2RlID0gdGhpcy5vcGVuVGFibGUucGVlaygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMub3BlblRhYmxlLmRlcXVldWUoKTtcbiAgICAgICAgdGhpcy5jbG9zZWRUYWJsZVtuZXdOb2RlLmlkZW50aWZpZXJdID0gbmV3Tm9kZTtcbiAgICAgICAgdGhpcy5jdXJyZW50Tm9kZSA9IG5ld05vZGU7XG4gICAgICAgIGxldCBjaGlsZHJlbiA9IHRoaXMuY3VycmVudE5vZGUuZ2V0Q2hpbGRyZW4oKTtcbiAgICAgICAgZm9yIChsZXQgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIHRoaXMuYWRkTmV3T3Blbk5vZGVXaXRoVmFsKGNoaWxkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW25ld05vZGUuc3RhdGUsIG5ld05vZGUuYmxhbmtJbmRleF07XG4gICAgfVxuXG4gICAgcHVibGljIGdldExvd2VzdE5vZGUoKSA6IG5vZGV8dW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlblRhYmxlLnBlZWsoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcnVuQWxsKCk6IGFueSB7XG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBsZXQgW3N0YXRlLCBibGFua10gPSB0aGlzLm5leHQoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrUmVzdWx0KHN0YXRlKSkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGNoZWNrUmVzdWx0KHN0YXRlOiBudW1iZXJbXSk6IGJvb2xlYW4ge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDk7IGkrKykge1xuICAgICAgICAgICAgaWYgKHN0YXRlW2ldICE9PSBpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcGF0aFRvQ3VycmVudCgpOiBub2RlW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Tm9kZS5wYXRoO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc3RlcHMoKSB7IHJldHVybiB0aGlzLnRvdGFsU3RlcDsgfVxuXG4gICAgcHVibGljIGFic3RyYWN0IGFkZE5ld09wZW5Ob2RlV2l0aFZhbChuZXdOb2RlOiBub2RlKTogdm9pZDtcblxufVxuXG5jbGFzcyBhU3RhckgxIGV4dGVuZHMgc2VhcmNoTWV0aG9ke1xuXG4gICAgcHVibGljIGFkZE5ld09wZW5Ob2RlV2l0aFZhbChuZXdOb2RlOiBub2RlKTogdm9pZCB7XG4gICAgICAgIGlmICghKG5ld05vZGUuaWRlbnRpZmllciBpbiB0aGlzLmNsb3NlZFRhYmxlKSkge1xuICAgICAgICAgICAgLy9UaGUgY29zdCBmcm9tIHJvb3QgdG8gdGhlIGN1cnJlbnQgbm9kZSwgaS5lIGcqKG4pXG4gICAgICAgICAgICBsZXQgY3VycmVudENvc3QgPSBuZXdOb2RlLnBhdGgubGVuZ3RoO1xuICAgICAgICAgICAgLy9UaGUgY29zdCBmcm9tIGN1cnJlbnQgbm9kZSB0byBkZXN0aW5hdGlvbihoMSoobikpIGlzIGVzdGltYXRlZFxuICAgICAgICAgICAgLy9ieSB0aGUgbnVtYmVyIG9mIG1pc3BsYWNlZCBudW1iZXJzLlxuICAgICAgICAgICAgbGV0IGVzdGltYXRlZE1pbkNvc3QgPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXdOb2RlLnN0YXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5ld05vZGUuc3RhdGVbaV0gIT09IGkpIHtcbiAgICAgICAgICAgICAgICAgICAgZXN0aW1hdGVkTWluQ29zdCArPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ld05vZGUudmFsdWUgPSBjdXJyZW50Q29zdCArIGVzdGltYXRlZE1pbkNvc3Q7XG5cbiAgICAgICAgICAgIHRoaXMub3BlblRhYmxlLnF1ZXVlKG5ld05vZGUpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5jbGFzcyBhU3RhckgyIGV4dGVuZHMgc2VhcmNoTWV0aG9ke1xuXG4gICAgcHVibGljIGFkZE5ld09wZW5Ob2RlV2l0aFZhbChuZXdOb2RlOiBub2RlKTogdm9pZCB7XG4gICAgICAgIGlmICghKG5ld05vZGUuaWRlbnRpZmllciBpbiB0aGlzLmNsb3NlZFRhYmxlKSkge1xuICAgICAgICAgICAgLy9UaGUgY29zdCBmcm9tIHJvb3QgdG8gdGhlIGN1cnJlbnQgbm9kZSwgaS5lIGcqKG4pXG4gICAgICAgICAgICBsZXQgY3VycmVudENvc3QgPSBuZXdOb2RlLnBhdGgubGVuZ3RoO1xuICAgICAgICAgICAgLy9UaGUgY29zdCBmcm9tIGN1cnJlbnQgbm9kZSB0byBkZXN0aW5hdGlvbihoMSoobikpIGlzIGVzdGltYXRlZFxuICAgICAgICAgICAgLy9ieSB0aGUgc3VtIG9mIHRoZSBjb2x1bW4gYW5kIHJvdyBkaWZmZXJlbmNlcyBpbiBlYWNoIHBvc2l0aW9uLlxuICAgICAgICAgICAgbGV0IGVzdGltYXRlZE1pbkNvc3QgPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXdOb2RlLnN0YXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgLy9Sb3cgZGlmZmVyZW5jZXNcbiAgICAgICAgICAgICAgICBlc3RpbWF0ZWRNaW5Db3N0ICs9IE1hdGguYWJzKGkvMyAtIG5ld05vZGUuc3RhdGVbaV0vMyk7XG4gICAgICAgICAgICAgICAgLy9Db2x1bW4gZGlmZmVyZW5jZXNcbiAgICAgICAgICAgICAgICBlc3RpbWF0ZWRNaW5Db3N0ICs9IE1hdGguYWJzKGklMyAtIG5ld05vZGUuc3RhdGVbaV0lMyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXdOb2RlLnZhbHVlID0gY3VycmVudENvc3QgKyBlc3RpbWF0ZWRNaW5Db3N0O1xuXG4gICAgICAgICAgICB0aGlzLm9wZW5UYWJsZS5xdWV1ZShuZXdOb2RlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgYmZzIGV4dGVuZHMgc2VhcmNoTWV0aG9kIHtcblxuICAgIHB1YmxpYyBhZGROZXdPcGVuTm9kZVdpdGhWYWwobmV3Tm9kZTogbm9kZSk6IHZvaWQge1xuICAgICAgICBpZiAoIShuZXdOb2RlLmlkZW50aWZpZXIgaW4gdGhpcy5jbG9zZWRUYWJsZSkpIHtcbiAgICAgICAgICAgIG5ld05vZGUudmFsdWUgPSAoPG5vZGU+bmV3Tm9kZS5wYXJlbnQpLnZhbHVlICsgMTtcbiAgICAgICAgICAgIHRoaXMub3BlblRhYmxlLnF1ZXVlKG5ld05vZGUpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5cblxuIl19